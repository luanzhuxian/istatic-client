import Fetch from './fetch'
import { Message, Loading } from 'element-ui'

let loadingInstance = null

const fetch = new Fetch({
  headers: {
    'Content-Type': 'application/json'
  },
  timeout: 15000
})

fetch.interceptors.request = (url, config) => {
  loadingInstance = Loading.service({ text: '拼命加载中...', background: 'transparent' })
  return config
}

fetch.interceptors.response = async resPromise => {
  try {
    const res = await resPromise
    if (res instanceof Blob) {
      return res
    }
    if (res.status !== 200) {
      throw new Error(res.devMessage || res.message)
    }
    return res
  } catch (e) {
    Message.error(e.message)
    throw e
  } finally {
    loadingInstance.close()
  }
}

export default fetch
